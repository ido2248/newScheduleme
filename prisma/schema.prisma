generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// === NextAuth required models ===

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String
  accounts      Account[]
  sessions      Session[]
  calendars     Calendar[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// === Application models ===

model Calendar {
  id                 String             @id @default(cuid())
  teacherId          String
  name               String
  code               String             @unique
  allowedGrades      Int[]
  maxStudentsPerSlot Int                @default(1)
  isActive           Boolean            @default(true)
  teacher            User               @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  availabilitySlots  AvailabilitySlot[]
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([teacherId])
  @@index([code])
}

model AvailabilitySlot {
  id           String           @id @default(cuid())
  calendarId   String
  dayOfWeek    Int              // 0=Sunday, 1=Monday, ..., 6=Saturday
  periodNumber Int              // 1-12 (school period/hour number)
  validFrom    DateTime?        @db.Date // null = permanent (always valid)
  validUntil   DateTime?        @db.Date // null = permanent (always valid)
  calendar     Calendar         @relation(fields: [calendarId], references: [id], onDelete: Cascade)
  bookings     Booking[]
  exceptions   SlotException[]

  @@index([calendarId])
  @@index([calendarId, dayOfWeek, periodNumber])
}

model SlotException {
  id        String           @id @default(cuid())
  slotId    String
  startDate DateTime         @db.Date
  endDate   DateTime         @db.Date
  slot      AvailabilitySlot @relation(fields: [slotId], references: [id], onDelete: Cascade)

  @@index([slotId])
  @@index([slotId, startDate, endDate])
}

model Booking {
  id                 String           @id @default(cuid())
  availabilitySlotId String
  date               DateTime         @db.Date
  studentName        String
  studentGrade       Int
  availabilitySlot   AvailabilitySlot @relation(fields: [availabilitySlotId], references: [id], onDelete: Cascade)
  createdAt          DateTime         @default(now())

  @@index([availabilitySlotId, date])
}
